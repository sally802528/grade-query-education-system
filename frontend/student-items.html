<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title id="project-title-name">項目詳情</title>
    </head>
<body>
    <div class="header">
        <h1>學生項目詳情</h1>
        </div>
    
    <div class="container">
        <div class="project-info">
            <h2><span id="project-name"></span></h2>
            <p><strong>狀態：</strong><span id="project-status"></span></p>
            <p><strong>截止日期：</strong><span id="project-deadline"></span></p>
            <p id="project-description"></p>
        </div>

        <div id="submission-area">
            <h3>檔案繳交</h3>
            <form id="submission-form" enctype="multipart/form-data">
                <input type="file" id="assignment-file" name="assignmentFile" required>
                <button type="submit" class="btn primary">提交檔案並請求審核</button>
            </form>
            <p id="submission-message" style="color: green; margin-top: 10px;"></p>
            <p id="current-submission" style="margin-top: 10px;"></p>
        </div>

        <div id="comment-section" style="margin-top: 30px;">
            <h3>項目溝通留言區</h3>
            <div id="comments-list" style="border: 1px solid #ccc; padding: 15px; max-height: 300px; overflow-y: scroll;">
                </div>
            <form id="comment-form" style="margin-top: 15px;">
                <textarea id="comment-text" style="width: 100%; height: 60px;" placeholder="輸入您的留言..."></textarea>
                <button type="submit" class="btn primary small">送出留言</button>
            </form>
        </div>
    </div>
    
    <script>
        const BASE_URL = 'http://localhost:5000/api';
        
        // --- 輔助函式 (從 URL 取得項目 ID) ---
        function getProjectIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // ... (檢查登入邏輯，請沿用 index.html 的 checkAuth) ...
            const projectId = getProjectIdFromUrl();
            if (!projectId) {
                alert('無效的項目 ID');
                return;
            }

            await loadProjectDetail(projectId);
            
            document.getElementById('comment-form').addEventListener('submit', handlePostComment);
            document.getElementById('submission-form').addEventListener('submit', handleSubmitFile);
        });

        // --- 載入資料 ---
        async function loadProjectDetail(projectId) {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${BASE_URL}/student/projects/${projectId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                document.getElementById('project-name').textContent = data.name;
                document.getElementById('project-title-name').textContent = data.name;
                document.getElementById('project-status').textContent = data.status;
                document.getElementById('project-deadline').textContent = data.deadline;
                document.getElementById('project-description').textContent = data.description;
                
                renderMessages(data.messages);
                // 處理已繳交檔案的顯示
                if (data.current_submission_url) {
                    document.getElementById('current-submission').innerHTML = 
                        `<a href="${data.current_submission_url}" target="_blank">查看已繳交檔案</a>`;
                }

            } catch (e) {
                alert('載入項目詳情失敗。');
            }
        }

        // --- 渲染留言 ---
        function renderMessages(messages) {
            const list = document.getElementById('comments-list');
            list.innerHTML = '';
            const currentUserId = 'S' + localStorage.getItem('id'); // 假設 id 存儲在 localStorage

            messages.forEach(comment => {
                const div = document.createElement('div');
                div.style.marginBottom = '10px';
                
                const roleText = comment.role === 'teacher' ? '【教師】' : '【學生】';
                div.innerHTML = `
                    <strong>${roleText} ${comment.authorName}:</strong>
                    <p style="margin: 5px 0 0 0;">${comment.content}</p>
                    <span style="font-size: 0.8em; color: #666;">${comment.timestamp}</span>
                `;
                
                // 撤回自己的留言功能
                if (comment.authorId === currentUserId && comment.role === 'student') {
                    const withdrawBtn = document.createElement('button');
                    withdrawBtn.textContent = '撤回';
                    withdrawBtn.className = 'btn secondary small';
                    withdrawBtn.style.marginLeft = '10px';
                    withdrawBtn.onclick = () => handleWithdrawComment(comment.id);
                    div.appendChild(withdrawBtn);
                }
                
                list.appendChild(div);
            });
            list.scrollTop = list.scrollHeight; // 滾動到底部
        }

        // --- 事件處理：新增留言 ---
        async function handlePostComment(e) {
            e.preventDefault();
            const commentTextarea = document.getElementById('comment-text');
            const content = commentTextarea.value.trim();
            const projectId = getProjectIdFromUrl();
            const token = localStorage.getItem('token');

            if (!content) return alert('留言內容不能為空！');

            try {
                const response = await fetch(`${BASE_URL}/student/messages/${projectId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ content })
                });

                const result = await response.json();

                if (response.ok) {
                    commentTextarea.value = ''; // 清空輸入框
                    // 實際應使用後端返回的完整列表，這裡簡化為重新載入
                    await loadProjectDetail(projectId);
                } else {
                    alert('留言失敗：' + (result.message || '伺服器錯誤'));
                }
            } catch (error) {
                alert('連線錯誤，請確認後端是否運行。');
            }
        }

        // --- 事件處理：撤回留言 ---
        async function handleWithdrawComment(messageId) {
            if (!confirm('您確定要撤回這則留言嗎？')) return;

            const projectId = getProjectIdFromUrl();
            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`${BASE_URL}/student/messages/${messageId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    alert('留言撤回成功！');
                    await loadProjectDetail(projectId); // 重新載入介面
                } else {
                    const result = await response.json();
                    alert('撤回失敗：' + (result.message || '您沒有權限或留言不存在。'));
                }
            } catch (error) {
                 alert('連線錯誤。');
            }
        }

        // --- 事件處理：繳交檔案 (FormData) ---
        async function handleSubmitFile(e) {
            e.preventDefault();
            const fileInput = document.getElementById('assignment-file');
            const messageP = document.getElementById('submission-message');
            messageP.textContent = '';
            
            if (fileInput.files.length === 0) {
                return alert('請選擇一個檔案。');
            }

            const projectId = getProjectIdFromUrl();
            const token = localStorage.getItem('token');
            
            // 使用 FormData 來處理檔案上傳
            const formData = new FormData(e.target); 
            
            try {
                const response = await fetch(`${BASE_URL}/student/submit/${projectId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }, // 注意：Content-Type 會被 FormData 自動設置
                    body: formData
                });
                
                const result = await response.json();

                if (response.ok) {
                    messageP.textContent = result.message;
                    // 繳交成功後更新狀態
                    document.getElementById('project-status').textContent = '待審核'; 
                    // 實際應清空檔案輸入欄
                    fileInput.value = '';
                } else {
                    messageP.textContent = '繳交失敗: ' + (result.message || '伺服器錯誤');
                    messageP.style.color = 'red';
                }
            } catch (error) {
                 messageP.textContent = '連線錯誤，請確認後端服務。';
                 messageP.style.color = 'red';
            }
        }
    </script>
</body>
</html>
